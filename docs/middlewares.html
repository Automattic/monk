
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Middlewares Â· Monk</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-prism/prism.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="Debugging.html" />
    
    
    <link rel="prev" href="GETTING_STARTED.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        <li class="header">Monk</li>
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="GETTING_STARTED.html">
            
                <a href="GETTING_STARTED.html">
            
                    
                    Getting Started
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Guides</li>
        
        
    
        <li class="chapter active" data-level="2.1" data-path="middlewares.html">
            
                <a href="middlewares.html">
            
                    
                    Middlewares
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.2" data-path="Debugging.html">
            
                <a href="Debugging.html">
            
                    
                    Debugging
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.3" data-path="writing-middleware.html">
            
                <a href="writing-middleware.html">
            
                    
                    Writing a middleware
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">API Reference</li>
        
        
    
        <li class="chapter " data-level="3.1" data-path="manager/">
            
                <a href="manager/">
            
                    
                    Manager
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.1" data-path="manager/close.html">
            
                <a href="manager/close.html">
            
                    
                    close
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.2" data-path="manager/create.html">
            
                <a href="manager/create.html">
            
                    
                    create
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.3" data-path="manager/get.html">
            
                <a href="manager/get.html">
            
                    
                    get
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.4" data-path="manager/addMiddleware.html">
            
                <a href="manager/addMiddleware.html">
            
                    
                    addMiddleware
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3.2" data-path="collection/">
            
                <a href="collection/">
            
                    
                    Collection
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.2.1" data-path="collection/aggregate.html">
            
                <a href="collection/aggregate.html">
            
                    
                    aggregate
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.2.2" data-path="collection/bulkWrite.html">
            
                <a href="collection/bulkWrite.html">
            
                    
                    bulkWrite
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.2.3" data-path="collection/count.html">
            
                <a href="collection/count.html">
            
                    
                    count
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.2.4" data-path="collection/createIndex.html">
            
                <a href="collection/createIndex.html">
            
                    
                    createIndex
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.2.5" data-path="collection/distinct.html">
            
                <a href="collection/distinct.html">
            
                    
                    distinct
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.2.6" data-path="collection/drop.html">
            
                <a href="collection/drop.html">
            
                    
                    drop
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.2.7" data-path="collection/dropIndex.html">
            
                <a href="collection/dropIndex.html">
            
                    
                    dropIndex
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.2.8" data-path="collection/dropIndexes.html">
            
                <a href="collection/dropIndexes.html">
            
                    
                    dropIndexes
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.2.9" data-path="collection/find.html">
            
                <a href="collection/find.html">
            
                    
                    find
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.2.10" data-path="collection/findOne.html">
            
                <a href="collection/findOne.html">
            
                    
                    findOne
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.2.11" data-path="collection/findOneAndDelete.html">
            
                <a href="collection/findOneAndDelete.html">
            
                    
                    findOneAndDelete
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.2.12" data-path="collection/findOneAndUpdate.html">
            
                <a href="collection/findOneAndUpdate.html">
            
                    
                    findOneAndUpdate
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.2.13" data-path="collection/geoHaystackSearch.html">
            
                <a href="collection/geoHaystackSearch.html">
            
                    
                    geoHaystackSearch
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.2.14" data-path="collection/geoNear.html">
            
                <a href="collection/geoNear.html">
            
                    
                    geoNear
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.2.15" data-path="collection/group.html">
            
                <a href="collection/group.html">
            
                    
                    group
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.2.16" data-path="collection/indexes.html">
            
                <a href="collection/indexes.html">
            
                    
                    indexes
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.2.17" data-path="collection/insert.html">
            
                <a href="collection/insert.html">
            
                    
                    insert
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.2.18" data-path="collection/mapReduce.html">
            
                <a href="collection/mapReduce.html">
            
                    
                    mapReduce
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.2.19" data-path="collection/remove.html">
            
                <a href="collection/remove.html">
            
                    
                    remove
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.2.20" data-path="collection/stats.html">
            
                <a href="collection/stats.html">
            
                    
                    stats
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.2.21" data-path="collection/update.html">
            
                <a href="collection/update.html">
            
                    
                    update
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3.3" data-path="id.html">
            
                <a href="id.html">
            
                    
                    id
            
                </a>
            

            
        </li>
    

    
        
        <li class="divider"></li>
        
        
    
        <li class="chapter " data-level="4.1" data-path="../CHANGELOG.html">
            
                <a href="../CHANGELOG.html">
            
                    
                    Change Log
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.2" >
            
                <a target="_blank" href="https://github.com/Automattic/monk/graphs/contributors">
            
                    
                    Contributors
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Middlewares</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="middleware">Middleware</h1>
<p><em>If you are familiar with <a href="http://redux.js.org/" target="_blank">Redux</a> and Redux middlewares, you are familiar with Monk middlewares. They use a very similar signature and architecture.</em></p>
<p>If you&apos;ve used server-side libraries like <a href="http://expressjs.com/" target="_blank">Express</a> and <a href="http://koajs.com/" target="_blank">Koa</a>, you were also probably already familiar with the concept of <em>middleware</em>. In these frameworks, middleware is some code you can put between the framework receiving a request, and the framework generating a response. For example, Express or Koa middleware may add CORS headers, logging, compression, and more. The best feature of middleware is that it&apos;s composable in a chain. You can use multiple independent third-party middleware in a single project.</p>
<p>Monk middleware solves different problems than Express or Koa middleware, but in a conceptually similar way. <strong>It provides a third-party extension point between calling a method, and the moment it reaches the mongo driver.</strong> Most of the Monk features are implemented as Monk middleware: logging, handling callbacks or promises, casting the <code>_id</code>s, waiting for the database connection to open, and more.</p>
<h2 id="understanding-middleware">Understanding Middleware</h2>
<p>While middleware can be used for a variety of things, including deferencing, it&apos;s really important that you understand where it comes from. We&apos;ll guide you through the thought process leading to middleware, by using logging and crash reporting as examples.</p>
<h3 id="problem-logging">Problem: Logging</h3>
<p>Wouldn&apos;t it be nice if we logged every query that happens in the app, together with the result after it? When something goes wrong, we can look back at our log, and figure out which query broke.</p>
<p>How do we approach this with Monk?</p>
<h3 id="attempt-1-logging-manually">Attempt #1: Logging Manually</h3>
<p>The most na&#xEF;ve solution is just to log the query and the result yourself every time you call a method (<a href="collection/insert.html"><code>db.collection.insert(item)</code></a> for example). It&apos;s not really a solution, but just a first step towards understanding the problem.</p>
<p>Say, you call this when creating a todo:</p>
<pre class="language-"><code class="lang-js">db<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&apos;todos&apos;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token punctuation">{</span>text<span class="token operator">:</span> <span class="token string">&apos;Use Monk&apos;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
<p>To log the query and result, you can change it to something like this:</p>
<pre class="language-"><code class="lang-js"><span class="token keyword">let</span> todo <span class="token operator">=</span> <span class="token punctuation">{</span>text<span class="token operator">:</span> <span class="token string">&apos;Use Monk&apos;</span><span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&apos;inserting&apos;</span><span class="token punctuation">,</span> todo<span class="token punctuation">)</span>
db<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&apos;todos&apos;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>todo<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&apos;inserting result&apos;</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span>
  <span class="token keyword">return</span> res
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<p>This produces the desired effect, but you wouldn&apos;t want to do it every time.</p>
<h3 id="attempt-2-wrapping-method">Attempt #2: Wrapping Method</h3>
<p>You can extract logging into a function:</p>
<pre class="language-"><code class="lang-js"><span class="token keyword">function</span> <span class="token function">queryAndLog</span><span class="token punctuation">(</span><span class="token parameter">collection<span class="token punctuation">,</span> method<span class="token punctuation">,</span> <span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token punctuation">)</span>
  collection<span class="token punctuation">[</span>method<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>method <span class="token operator">+</span> <span class="token string">&apos; result&apos;</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span>
    <span class="token keyword">return</span> res
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p>You can then use it everywhere instead of <code>db.get(collection).method()</code>:</p>
<pre class="language-"><code class="lang-js"><span class="token function">queryAndLog</span><span class="token punctuation">(</span>db<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&apos;todos&apos;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&apos;insert&apos;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>text<span class="token operator">:</span> <span class="token string">&apos;Use Monk&apos;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<p>We could end this here, but it&apos;s not very convenient to import a special function every time.</p>
<h3 id="attempt-3-monkeypatching-method">Attempt #3: Monkeypatching Method</h3>
<p>What if we just replace the <code>insert</code> function on the store instance? We&apos;re writing JavaScript, so we can just monkeypatch the <code>insert</code> implementation:</p>
<pre class="language-"><code class="lang-js"><span class="token keyword">let</span> next <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&apos;todos&apos;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>insert
db<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&apos;todos&apos;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function-variable function">insert</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">insertAndLog</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&apos;insert&apos;</span><span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&apos;insert result&apos;</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span>
    <span class="token keyword">return</span> res
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p>This is already closer to what we want!  No matter where we insert, it is guaranteed to be logged. Monkeypatching never feels right, but we can live with this for now. We would need to do that for each method of every collections tho. But let&apos;s say we only need to for a couple of methods, we could still live with this.</p>
<h3 id="problem-crash-reporting">Problem: Crash Reporting</h3>
<p>What if we want to apply <strong>more than one</strong> such transformation to <code>insert</code>?</p>
<p>A different useful transformation that comes to my mind is reporting JavaScript errors in production.</p>
<p>Wouldn&apos;t it be useful if, any time an error is thrown as a result of a mongo query, we would send it to a crash reporting service like <a href="https://getsentry.com/welcome/" target="_blank">Sentry</a> with the query and the current state? This way it&apos;s much easier to reproduce the error in development.</p>
<p>However, it is important that we keep logging and crash reporting separate. Ideally we want them to be different modules, potentially in different packages. Otherwise we can&apos;t have an ecosystem of such utilities. (Hint: we&apos;re slowly getting to what middleware is!)</p>
<p>If logging and crash reporting are separate utilities, they might look like this:</p>
<pre class="language-"><code class="lang-js"><span class="token keyword">function</span> <span class="token function">patchMethodToAddLogging</span><span class="token punctuation">(</span><span class="token parameter">db<span class="token punctuation">,</span> collection<span class="token punctuation">,</span> method</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> next <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>collection<span class="token punctuation">)</span><span class="token punctuation">[</span>method<span class="token punctuation">]</span>
  db<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>collection<span class="token punctuation">)</span><span class="token punctuation">[</span>method<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">methodAndLog</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>method <span class="token operator">+</span> <span class="token string">&apos; result&apos;</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span>
      <span class="token keyword">return</span> res
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">patchMethodToAddCrashReporting</span><span class="token punctuation">(</span><span class="token parameter">db<span class="token punctuation">,</span> collection<span class="token punctuation">,</span> method</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> next <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>collection<span class="token punctuation">)</span><span class="token punctuation">[</span>method<span class="token punctuation">]</span>
  db<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>collection<span class="token punctuation">)</span><span class="token punctuation">[</span>method<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">methodAndReportErrors</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&apos;Caught an exception!&apos;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
      Raven<span class="token punctuation">.</span><span class="token function">captureException</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        extra<span class="token operator">:</span> <span class="token punctuation">{</span>
          method<span class="token punctuation">,</span>
          args
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token keyword">throw</span> err
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>If these functions are published as separate modules, we can later use them to patch our collection:</p>
<pre class="language-"><code class="lang-js"><span class="token function">patchMethodToAddLogging</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span> <span class="token string">&apos;todos&apos;</span><span class="token punctuation">,</span> <span class="token string">&apos;insert&apos;</span><span class="token punctuation">)</span>
<span class="token function">patchMethodToAddCrashReporting</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span> <span class="token string">&apos;todos&apos;</span><span class="token punctuation">,</span> <span class="token string">&apos;insert&apos;</span><span class="token punctuation">)</span>
</code></pre>
<p>Still, this isn&apos;t nice.</p>
<h3 id="attempt-4-hiding-monkeypatching">Attempt #4: Hiding Monkeypatching</h3>
<p>Monkeypatching is a hack. &#x201C;Replace any method you like&#x201D;, what kind of API is that? Let&apos;s figure out the essence of it instead. Previously, our functions replaced <code>db.collection.insert</code>. What if they <em>returned</em> the new <code>insert</code> function instead?</p>
<pre class="language-"><code class="lang-js"><span class="token keyword">function</span> <span class="token function">logger</span><span class="token punctuation">(</span><span class="token parameter">db<span class="token punctuation">,</span> collection<span class="token punctuation">,</span> method</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> next <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>collection<span class="token punctuation">)</span><span class="token punctuation">[</span>method<span class="token punctuation">]</span>

  <span class="token comment">// Previously:</span>
  <span class="token comment">// db.get(collection)[method] = function methodAndLog(...args) {</span>

  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">methodAndLog</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>method <span class="token operator">+</span> <span class="token string">&apos; result&apos;</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span>
      <span class="token keyword">return</span> res
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>We could provide a helper inside Redux that would apply the actual monkeypatching as an implementation detail:</p>
<pre class="language-"><code class="lang-js"><span class="token keyword">function</span> <span class="token function">applyMiddlewareByMonkeypatching</span><span class="token punctuation">(</span><span class="token parameter">db<span class="token punctuation">,</span> collection<span class="token punctuation">,</span> method<span class="token punctuation">,</span> middlewares</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  middlewares <span class="token operator">=</span> middlewares<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  middlewares<span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token comment">// Transform dispatch function with each middleware.</span>
  middlewares<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">middleware</span> <span class="token operator">=&gt;</span>
    db<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>collection<span class="token punctuation">)</span><span class="token punctuation">[</span>method<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">middleware</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span> collection<span class="token punctuation">,</span> method<span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p>We could use it to apply multiple middleware like this:</p>
<pre class="language-"><code class="lang-js"><span class="token function">applyMiddlewareByMonkeypatching</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span> <span class="token string">&apos;todos&apos;</span><span class="token punctuation">,</span> <span class="token string">&apos;insert&apos;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>logger<span class="token punctuation">,</span> crashReporter<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre>
<p>However, it is still monkeypatching.
The fact that we hide it inside the library doesn&apos;t alter this fact.</p>
<h3 id="attempt-5-removing-monkeypatching">Attempt #5: Removing Monkeypatching</h3>
<p>Why do we even overwrite <code>insert</code>? Of course, to be able to call it later, but there&apos;s also another reason: so that every middleware can access (and call) the previously wrapped <code>collection.method</code>:</p>
<pre class="language-"><code class="lang-js"><span class="token keyword">function</span> <span class="token function">logger</span><span class="token punctuation">(</span><span class="token parameter">db<span class="token punctuation">,</span> collection<span class="token punctuation">,</span> method</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Must point to the function returned by the previous middleware:</span>
  <span class="token keyword">let</span> next <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>collection<span class="token punctuation">)</span><span class="token punctuation">[</span>method<span class="token punctuation">]</span>

  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">methodAndLog</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>method <span class="token operator">+</span> <span class="token string">&apos; result&apos;</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span>
      <span class="token keyword">return</span> res
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>It is essential to chaining middleware!</p>
<p>If <code>applyMiddlewareByMonkeypatching</code> doesn&apos;t assign <code>collection.method</code> immediately after processing the first middleware, <code>collection.method</code> will keep pointing to the original <code>method</code> function. Then the second middleware will also be bound to the original <code>method</code> function.</p>
<p>But there&apos;s also a different way to enable chaining. The middleware could accept the <code>next()</code> insert function as a parameter instead of reading it from the <code>collection</code> instance.</p>
<pre class="language-"><code class="lang-js"><span class="token keyword">function</span> <span class="token function">logger</span><span class="token punctuation">(</span><span class="token parameter">context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">wrapMethodToAddLogging</span><span class="token punctuation">(</span><span class="token parameter">next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">methodAndLog</span><span class="token punctuation">(</span><span class="token parameter">args<span class="token punctuation">,</span> method</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> method<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>method <span class="token operator">+</span> <span class="token string">&apos; result&apos;</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span>
        <span class="token keyword">return</span> res
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>It&apos;s a <a href="http://knowyourmeme.com/memes/we-need-to-go-deeper" target="_blank">&#x201C;we need to go deeper&#x201D;</a> kind of moment, so it might take a while for this to make sense. The function cascade feels intimidating. ES6 arrow functions make this <a href="https://en.wikipedia.org/wiki/Currying" target="_blank">currying</a> easier on eyes:</p>
<pre class="language-"><code class="lang-js"><span class="token keyword">const</span> <span class="token function-variable function">logger</span> <span class="token operator">=</span> <span class="token parameter">context</span> <span class="token operator">=&gt;</span> <span class="token parameter">next</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>method <span class="token operator">+</span> <span class="token string">&apos; result&apos;</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span>
    <span class="token keyword">return</span> res
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">crashReporter</span> <span class="token operator">=</span> <span class="token parameter">context</span> <span class="token operator">=&gt;</span> <span class="token parameter">next</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&apos;Caught an exception!&apos;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    Raven<span class="token punctuation">.</span><span class="token function">captureException</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        extra<span class="token operator">:</span> <span class="token punctuation">{</span>
          method<span class="token punctuation">,</span>
          args
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">throw</span> err
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p><strong>This is exactly what Monk middleware looks like.</strong></p>
<p>Now middleware takes the <code>next()</code> dispatch function, and returns a dispatch function, which in turn serves as <code>next()</code> to the middleware to the left, and so on. It&apos;s still useful to have access to some context like the collection and the Monk instance, so <code>{collection, monkInstance}</code> stays available as the top-level argument.</p>
<h3 id="attempt-6-na&#xEF;vely-applying-the-middleware">Attempt #6: Na&#xEF;vely Applying the Middleware</h3>
<p>Instead of <code>applyMiddlewareByMonkeypatching()</code>, we could write <code>applyMiddleware()</code> that first obtains the final, fully wrapped <code>method()</code> function, and returns a copy of the method:</p>
<pre class="language-"><code class="lang-js"><span class="token comment">// Warning: Na&#xEF;ve implementation!</span>
<span class="token comment">// That&apos;s *not* Monk API.</span>
<span class="token keyword">function</span> <span class="token function">applyMiddleware</span><span class="token punctuation">(</span><span class="token parameter">db<span class="token punctuation">,</span> collection<span class="token punctuation">,</span> method<span class="token punctuation">,</span> middlewares</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  middlewares <span class="token operator">=</span> middlewares<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  middlewares<span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">let</span> next <span class="token operator">=</span> collection<span class="token punctuation">[</span>method<span class="token punctuation">]</span>
  middlewares<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">middleware</span> <span class="token operator">=&gt;</span>
    next <span class="token operator">=</span> <span class="token function">middleware</span><span class="token punctuation">(</span><span class="token punctuation">{</span>monkInstance<span class="token operator">:</span> db<span class="token punctuation">,</span> collection<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
  <span class="token keyword">return</span> next
<span class="token punctuation">}</span>
</code></pre>
<p>The implementation of <code>applyMiddleware()</code> that ships with Monk is similar, but <strong>different in a very important aspect</strong>:</p>
<p>It is called when first getting a collection so that the collection can automatically call the middlewares chain on every method.</p>
<p>As a result, instead of the method being in the first argument of the middleware, it is in the last.</p>
<h3 id="the-final-approach">The Final Approach</h3>
<p>Given this middleware we just wrote:</p>
<pre class="language-"><code class="lang-js"><span class="token keyword">const</span> <span class="token function-variable function">logger</span> <span class="token operator">=</span> <span class="token parameter">context</span> <span class="token operator">=&gt;</span> <span class="token parameter">next</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token parameter">args<span class="token punctuation">,</span> method</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> args<span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> method<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>method <span class="token operator">+</span> <span class="token string">&apos; result&apos;</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span>
    <span class="token keyword">return</span> res
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">crashReporter</span> <span class="token operator">=</span> <span class="token parameter">context</span> <span class="token operator">=&gt;</span> <span class="token parameter">next</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token parameter">args<span class="token punctuation">,</span> method</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> method<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&apos;Caught an exception!&apos;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    Raven<span class="token punctuation">.</span><span class="token function">captureException</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        extra<span class="token operator">:</span> <span class="token punctuation">{</span>
          method<span class="token punctuation">,</span>
          args
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">throw</span> err
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Here&apos;s how to apply it to a Monk instance:</p>
<pre class="language-"><code class="lang-js">db<span class="token punctuation">.</span><span class="token function">addMiddleware</span><span class="token punctuation">(</span>logger<span class="token punctuation">)</span>
db<span class="token punctuation">.</span><span class="token function">addMiddleware</span><span class="token punctuation">(</span>crashReporter<span class="token punctuation">)</span>
</code></pre>
<p>That&apos;s it! Now any method called by the monk instance will flow through <code>logger</code> and <code>crashReporter</code>:</p>
<pre class="language-"><code class="lang-js"><span class="token comment">// Will flow through both logger and crashReporter middleware!</span>
db<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&apos;todos&apos;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token punctuation">{</span>text<span class="token operator">:</span> <span class="token string">&apos;Use Monk&apos;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="GETTING_STARTED.html" class="navigation navigation-prev " aria-label="Previous page: Getting Started">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="Debugging.html" class="navigation navigation-next " aria-label="Next page: Debugging">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Middlewares","level":"2.1","depth":1,"next":{"title":"Debugging","level":"2.2","depth":1,"path":"docs/Debugging.md","ref":"docs/Debugging.md","articles":[]},"previous":{"title":"Getting Started","level":"1.2","depth":1,"path":"docs/GETTING_STARTED.md","ref":"docs/GETTING_STARTED.md","articles":[]},"dir":"ltr"},"config":{"plugins":["edit-link","prism","-highlight","github","anker-enable","custom-favicon"],"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"prism":{},"github":{"url":"https://github.com/Automattic/monk/"},"anker-enable":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"fontsettings":{"theme":"white","family":"sans","size":2},"favicon":"assets/favicon.ico","custom-favicon":{},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"edit-link":{"label":"Edit This Page","base":"https://github.com/Automattic/monk/redux/tree/master"},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"theme":"default","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"title":"Monk","gitbook":">=3.2.2","description":"The wise MongoDB API"},"file":{"path":"docs/middlewares.md","mtime":"2019-05-13T13:58:37.377Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2020-04-28T07:44:25.852Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-edit-link/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-github/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-anker-enable/anker.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

